<html>

<head>
  <title>DATASET</title>
</head>
<style>
  .node {
    cursor: pointer;
  }

  .node circle {
    fill: #9b8f8f;
    stroke: steelblue;
    stroke-width: 3px;
  }

  .node text {
    font: 12px sans-serif;
  }

  .link {
    fill: none;
    stroke: hsl(125, 54%, 36%);
    stroke-width: 0.5px;
  }

  div.tooltip {
    position: absolute;
    text-align: center;
    width: 300px;
    height: 100px;
    padding: 2px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0px;
    border-radius: 8px;
    pointer-events: none;
  }

  div.tooltips {
    position: absolute;
    text-align: center;
    width: 300px;
    height: 100px;
    padding: 2px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0px;
    border-radius: 8px;
    pointer-events: none;
  }

  .node:hover {
    stroke-width: 7px !important;
    opacity: 1 !important;
  }

  /*
    #lccontent, #dccontent, #space {
       
display: inline-block;
}
*/
</style>

<body>
  <div id="content">
    <h1>Class J</h1>
  </div>

  <script src="https://code.jquery.com/jquery-1.7.2.js"></script>
  <script src="https://d3js.org/d3.v4.js"></script>
  <script src="UpdateUoSLibrarySchema.js"></script>
  <script type="module">
    import { path } from "https://cdn.skypack.dev/d3-path@3";
  </script>
  <script>
    d3.queue()
      .defer(d3.json, "File/HierStructClassJ.json")
      .defer(d3.json, "File/CommonBooksJ-QNL.json")
      .await(function (error, struct, books) {
        if (error) throw error;

        console.log(struct.length);
        console.log(books.length);

        // d3.json("File/HierStructClassJ.json", function (struct) {

        d3.select("#content")
          .append("h4")
          .text("Total no. of nodes " + struct.length);
        //.style("font-size", "8px");

        var margin = { top: 100, right: 110, bottom: -100, left: 120 },
          height = 600 - margin.right - margin.left,
          width = 300 - margin.top - margin.bottom,
          rectW = 70;
        rectH = 30;
        //bbox = NaN,
        maxTextLength = 0;

        var svg = d3
          .select("#content")
          .append("svg")
          .attr("width", 2000)
          .attr("height", 2000);

        stratify = d3
          .stratify()
          .id(function (d) {
            return d.child;
          })
          .parentId(function (d) {
            return d.parent;
          });

        var stratify = stratify(struct);
        var rootElement = d3.hierarchy(stratify);

        var radius = 1300;

        var tree = d3
          .tree()
          .size([2 * Math.PI, radius])
          .separation(function (a, b) {
            return a.parent == b.parent ? 20000 : 10;
          });

        var g = svg
          .append("g")
          .attr("id", "uos")
          .attr(
            "transform",
            "translate(" + width + "," + (height + 790) + ")"
          );

        var root = tree(rootElement);

        var depth = 1;

        let filnodes = [];
        filnodes = filterNodes();
        let fillinks = [];
        fillinks = filterLinks();

        console.log(filnodes);
        console.log(fillinks);
        updateUoS();
        updateQNL();

        function updateUoS() {
          var Tooltips = d3
            .select("#content")
            .append("div")
            .style("opacity", 0)
            .attr("class", "tooltips")
            .style("background-color", "white")
            .style("border", "solid")
            .style("border-width", "2px")
            .style("border-radius", "5px")
            .style("padding", "5px");

          // Three function that change the tooltip when user hover / move / leave a cell
          var mouseover = function (d) {
            Tooltips.style("opacity", 1);
          };
          var mousemove = function (d) {
            var parentnode = this.parentNode.getAttribute("transform");

            var grandparentnode = d3.select("#uos").attr("transform");

            console.log(parentnode);
            console.log(grandparentnode);

            var transCoords = parentnode
              .substring(parentnode.indexOf("(") + 1, parentnode.indexOf(")"))
              .split(",");

            var gtransCoords = grandparentnode
              .substring(
                grandparentnode.indexOf("(") + 1,
                grandparentnode.indexOf(")")
              )
              .split(",");

            //console.log(transCoords[0] + " , " + transCoords[1]);
            console.log(d);
            Tooltips.html(
              " <b>Child CN: </b>" + d.data.data.child + "<br/><br/>"
            )
              .style(
                "left",
                parseInt(transCoords[0]) +
                parseInt(gtransCoords[0]) +
                30 +
                "px"
                // parseInt(this.getAttribute("cx")) + "px"
              )
              .style(
                "top",
                parseInt(transCoords[1]) +
                parseInt(gtransCoords[1]) +
                //  parseInt(this.getAttribute("cy")) +
                "px"
              );
          };
          var mouseleave = function (d) {
            Tooltips.style("opacity", 0);
          };

          console.log("start");
          console.log(filnodes);
          var node = g
            .selectAll(".node")
            .data(filnodes)
            // .data(root.descendants())
            .enter()
            .append("g")
            .attr("class", function (d) {
              //   console.log(d);
              return d.child;
            })
            .attr("transform", function (d) {
              // if (d.depth > 1)
              //  return "translate(" + fullRadialPoint(d.x, d.y) + ")";
              // else
              return "translate(" + radialPoint(d.x, d.y) + ")";
            });

          node
            .append("circle")
            .attr("cx", function (d) {
              // console.log(radialPoint(d.x, d.y));
              return 0;
            })
            .attr("cy", function (d) {
              return 0;
            })
            .attr("r", 6)
            .attr("class", function (d) {
              return (
                "node" + (d.children ? " node--internal" : " node--leaf")
              );
            })
            .attr("id", function (d) {
              return d.data.data.child
                .replace(/ /g, "")
                .replace("(", "")
                .replace(")", "")
                .toLowerCase();
            })
            .style("fill", "red")
            // .style("opacity", 1)

            .style("opacity", function (d) {
              return 1;
            })
            .on("mouseover", mouseover)
            .on("mousemove", mousemove)
            .on("mouseleave", mouseleave)

            .on("click", function (d) {
              var parentnode = this.parentNode.getAttribute("transform");

              var transCoords = parentnode
                .substring(
                  parentnode.indexOf("(") + 1,
                  parentnode.indexOf(")")
                )
                .split(",");

              if (d.depth == 1) {
                var angle = Math.atan2(transCoords[1], transCoords[0]);

                angle = angle * (180 / Math.PI);

                d3.select("svg")
                  .select("g")
                  .transition()
                  .duration(4000)
                  .attr(
                    "transform",
                    "translate(" +
                    (width + 100) +
                    "," +
                    (height + 90) +
                    ") rotate(" +
                    angle * -1 +
                    ")"
                  );
              }

              d3.select(this).classed("selectedparent", true);
              depth++;

              console.log(this);
              filterNodesDescendants(this);
              console.log(filnodes);
              fillinks = filterLinks();
              updateUoS();
              /* console.log("FINISHED UPDATE");
                     console.log("clicked node " + d.data.data.child); */

              d3.selectAll(".node").style("opacity", 0);
              d3.selectAll(".text").style("opacity", 0);
              d3.selectAll(".link").style("opacity", 0);
              d3.selectAll("#commonbooks")
                .selectAll("circle")
                .style("opacity", 1);

              //d3.selectAll("#root").style("opacity", 1);

              d3.selectAll("." + d3.select(this).attr("id")).style(
                "opacity",
                1
              );

              /*
                    //siblings
                    for (var j = 0; j < d.parent.children.length; j++) {
                      var nodename = d.parent.children[j].data.id
                        .replace(/ /g, "")
                        .replace("(", "")
                        .replace(")", "")
                        .toLowerCase();

                      d3.selectAll("." + d.parent.data.data.child).style(
                        "opacity",
                        1
                      );

                      d3.select("#" + nodename)
                        .transition()
                        .duration(2000)
                        .style("fill", "blue")
                        .style("opacity", 1);

                      //  console.log("siblings " + d.parent.children[j].children.length);

                      for (
                        var jj = 0;
                        jj < d.parent.children[j].children.length;
                        jj++
                      ) {
                        nodename = d.parent.children[j].children[jj].data.data.child
                          .replace(/ /g, "")
                          .replace("(", "")
                          .replace(")", "")
                          .toLowerCase();

                        // console.log(nodename);

                        d3.select("#" + nodename)
                          .transition()
                          .duration(2000)
                          //  .style("fill", "blue");
                          .style("opacity", 0);
                      }
                    }

                    console.log("ancestors " + d.ancestors().length);
                    //ancestors
                    for (var j = 0; j < d.ancestors().length; j++) {
                      var nodename = d
                        .ancestors()
                        [j].data.data.child.replace(/ /g, "")
                        .replace("(", "")
                        .replace(")", "")
                        .toLowerCase();

                      console.log(nodename);
                      d3.selectAll("." + nodename).style("opacity", 1);

                      d3.select("#" + nodename)
                        .transition()
                        .duration(2000)
                        .style("fill", "purple")
                        .style("opacity", 1);

                      //  console.log(nodename);
                    }

                    if (d.descendants().length > 1) {
                      console.log("descendants " + d.descendants().length);
                      //descendants
                      for (var j = 0; j < d.descendants().length; j++) {
                        var nodename = d
                          .descendants()
                          [j].data.data.child.replace(/ /g, "")
                          .replace("(", "")
                          .replace(")", "")
                          .toLowerCase();

                        d3.select("#" + nodename)
                          .transition()
                          .duration(2000)
                          //  .style("fill", "yellow")
                          .style("opacity", 1);

                        // console.log(nodename);
                      }
                    }
                    */
            });

          node
            .append("text")
            .style("font-size", "10px")

            .attr("class", function (d) {
              return d.data.data.child
                .replace(/ /g, "")
                .replace("(", "")
                .replace(")", "")
                .toLowerCase();
            })
            .classed("text", true)
            .attr("dy", "2em")
            .attr("x", function (d) {
              return d.x < Math.PI === !d.children ? -40 : 25;
            })
            .attr("text-anchor", function (d) {
              return d.x < Math.PI === !d.children ? "start" : "end";
            })
            .attr("transform", function (d) {
              return (
                "rotate(" +
                ((d.x < Math.PI ? d.x - Math.PI / 2 : d.x + Math.PI / 2) *
                  180) /
                Math.PI +
                ")"
              );
            })
            .style("opacity", function (d) {
              //  console.log(d);
              substr = d.data.id
                .replace(/ /g, "")
                .replace("(", "")
                .replace(")", "")
                .toLowerCase();
              var elementExists = !!document.getElementById(substr);
              // console.log(elementExists);
              // if (elementExists) {
              if (d3.selectAll("#" + substr).style("opacity") == 1) return 1;
              else return 0;
            })
            .text(function (d) {
              // console.log(d);
              return d.data.data.child;
            });

          var link = g
            .selectAll(".link")
            .data(fillinks)
            //.data(root.links())
            // .data(root.links().filter(function(d) { return d.source.depth <=1 }))
            .enter()
            .append("path")
            .attr("class", function (d) {
              return d.source.data.id
                .replace(/ /g, "")
                .replace("(", "")
                .replace(")", "")
                .toLowerCase();
            })
            .classed("link", true)
            .attr(
              "d",
              d3
                .linkRadial()
                .angle(function (d) {
                  return d.x;
                })
                .radius(function (d) {
                  return d.y;
                })
            )
            .style("opacity", function (d) {
              substr = d.target.data.id
                .replace(/ /g, "")
                .replace("(", "")
                .replace(")", "")
                .toLowerCase();
              var elementExists = !!document.getElementById(substr);
              console.log(elementExists);
              // if (elementExists) {
              if (d3.selectAll("#" + substr).style("opacity") == 1) return 1;
              else return 0;
              // }
            });
        }

        function updateQNL() {
          var Tooltip = d3
            .select("#content")
            .append("div")
            .style("opacity", 0)
            .attr("class", "tooltip")
            .style("background-color", "white")
            .style("border", "solid")
            .style("border-width", "2px")
            .style("border-radius", "5px")
            .style("padding", "5px");

          // Three function that change the tooltip when user hover / move / leave a cell
          var mouseover = function (d) {
            Tooltip.style("opacity", 1);
          };
          var mousemove = function (d) {
            var parentnode = this.parentNode.getAttribute("transform");

            console.log(this.getAttribute("cx"));

            var transCoords = parentnode
              .substring(parentnode.indexOf("(") + 1, parentnode.indexOf(")"))
              .split(",");

            Tooltip.html(
              d.title +
              "<br/><br/>" +
              " <b>QNL CN: </b>" +
              d.qnlcn +
              "<br/><b>UOS CN: </b>" +
              d.uoscn
            )
              .style(
                "left",
                parseInt(transCoords[0]) +
                parseInt(this.getAttribute("cx")) +
                "px"
              )
              .style(
                "top",
                parseInt(transCoords[1]) +
                parseInt(this.getAttribute("cy")) +
                "px"
              );
          };
          var mouseleave = function (d) {
            Tooltip.style("opacity", 0);
          };

          var categories = [];
          var substr = "";
          for (var i = 0; i < books.length; i++) {
            if (!isNaN(books[i].qnlcn.substring(1, 2)))
              substr = books[i].qnlcn.substring(0, 1);
            else substr = books[i].qnlcn.substring(0, 2);
            //   console.log(substr);
            if (!categories.includes(substr)) categories.push(substr);
          }

          console.log(categories);

          var scaleColor = d3.scaleBand().domain(categories).range([0, 1]);
          var scaleCenter = d3
            .scaleBand()
            .domain(categories)
            .range([0, categories.length - 1]);

          var bandScale = d3.scaleBand().domain(categories).range([0, 850]);

          // console.log(d3.interpolateRainbow(scaleColor("JC")));

          // var scaleColor=d3.scaleOrdinal().domain(categories).interpolator(d3.interpolateRgb);
          //  console.log(scaleColors(""));

          var node = svg
            .append("g")
            .attr("id", "commonbooks")
            .attr("transform", "translate(400,1400)")
            .selectAll("circle")
            .data(books)
            .enter()
            .append("circle")
            .attr("class", "node")
            .attr("r", function (d) {
              return 8;
            })
            .attr("cx", width / 2)
            .attr("cy", height / 2)
            .style("fill", function (d) {
              // console.log(d.qnlcn.substring(0, 2));
              //   console.log(scaleColor(d.qnlcn.substring(0, 2)));
              if (!isNaN(d.qnlcn.substring(1, 2)))
                substr = d.qnlcn.substring(0, 1);
              else substr = d.qnlcn.substring(0, 2);
              return d3.interpolateRainbow(scaleColor(substr));
            })
            .style("fill-opacity", 0.8)
            .attr("stroke", "black")
            .style("stroke-width", 1)
            .on("mouseover", mouseover)
            .on("mousemove", mousemove)
            .on("mouseleave", mouseleave)
            .call(
              d3
                .drag() // call specific function when circle is dragged
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended)
            );

          //d.qnlcn.substring(0, 2)
          var xCenter = [];
          var center = 0;
          for (var i = 0; i < categories.length; i++) {
            xCenter.push(center);
            if (i > 5) center = center + 40;
            else center = center + 100;
          }

          console.log(xCenter);
          var simulation = d3
            .forceSimulation(books)
            .force("charge", d3.forceManyBody().strength(0))
            .force(
              "x",
              d3.forceX().x(function (d) {
                if (!isNaN(d.qnlcn.substring(1, 2)))
                  substr = d.qnlcn.substring(0, 1);
                else substr = d.qnlcn.substring(0, 2);
                return xCenter[Math.round(scaleCenter(substr))];
              })
            )
            .force(
              "collision",
              d3.forceCollide().radius(function (d) {
                //  console.log(d.radius);
                return 8;
              })
            )

            .on("tick", ticked);

          // let scale = d3.scaleLinear().domain([0, 100]).range([0, 400]);
          var axis = d3.axisBottom();
          axis.scale(bandScale);

          console.log(axis);
          d3.select("#commonbooks")
            .append("g")
            .attr("transform", "translate(0,300)")
            .call(axis);

          function ticked() {
            node
              .attr("cx", function (d) {
                // console.log(d.x);
                return d.x;
              })
              .attr("cy", function (d) {
                return d.y;
              });
          }

          // What happens when a circle is dragged?
          function dragstarted(d) {
            if (!d3.event.active) simulation.alphaTarget(0.03).restart();
            d.fx = d.x;
            d.fy = d.y;
          }
          function dragged(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
          }
          function dragended(d) {
            if (!d3.event.active) simulation.alphaTarget(0.03);
            d.fx = null;
            d.fy = null;
          }
        }

        function radialPoint(x, y) {
          return [(y = +y) * Math.cos((x -= Math.PI / 2)), y * Math.sin(x)];
        }

        function fullRadialPoint(x, y) {
          return [(y = +y) * Math.cos((x -= Math.PI)), y * Math.sin(x)];
        }

        /*
                    function rotateViz() {
                      //  console.log("rotate viz");
                      node.transition().duration(2000).attrTween("transform", tween);

                      function tween(d, i, a) {
                        return d3.interpolateString(
                          "rotate(-60, 150, 130)",
                          "rotate(60, 150, 130)"
                        );
                      }
                    }
                    */

        function filterNodes() {
          var selectedparent =
            document.getElementsByClassName("selectedparent");

          if (selectedparent == null)
            selectedparent = document.getElementById("root");

          //  console.log(selectedparent);

          var filnodes = root.descendants().filter(function (d) {
            //if (depth <= 1)
            return d.descendants().includes(d) && d.depth <= 1;
            //  else return d.descendants().includes(d);
            // return d.descendants().includes(d);
            //  return d.depth <= depth;
          });
          return filnodes;
        }

        function filterNodesDescendants(parent) {
          //  console.log(parent);
          //  console.log(parent.getAttribute("id"));
          var selectedparent =
            document.getElementsByClassName("selectedparent");

          if (selectedparent == null)
            selectedparent = document.getElementById("root");

          //  console.log(selectedparent);

          // console.log(d3.select("#" + parent.getAttribute("id")));

          //var filnodes =
          root.descendants().filter(function (d) {
            //  console.log(d);

            var nodeparent = d.data.id
              .replace(/ /g, "")
              .replace("(", "")
              .replace(")", "")
              .toLowerCase();
            // console.log(d.descendants());
            /*
                  return nodeparent == parent.getAttribute("id")
                    ? d.descendants()
                    : null;
                    */

            if (nodeparent == parent.getAttribute("id")) {
              console.log("match");
              console.log(d.descendants());
              filnodes = d.descendants();
              return d.descendants();
            }

            // return d.descendants().includes(d);
            //  return d.depth <= depth;
          });
          console.log("indise");
          console.log(filnodes);
          // return filnodes;
        }

        function filterLinks() {
          var fillinks = root.links().filter(function (d) {
            if (filnodes.includes(d.target)) return d;
            //d.descendants().includes(d.t)
            // return d.target.depth <= depth;
          });
          return fillinks;
        }
      });
  </script>
</body>

</html>