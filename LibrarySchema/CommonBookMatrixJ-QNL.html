<html>

<head>
    <title>Matrix: J & QNL</title>
</head>
<style>
    h1 {
        font: 60px sans-serif;
    }

    h2 {
        font: 50px times;
    }

    div.tooltip {
        position: absolute;
        text-align: center;
        width: 800px;
        height: 410px;
        padding: 2px;
        font: 40px sans-serif;
        background: rgb(131, 216, 181);
        border: 0px;
        margin-top: 40px;
        border-radius: 8px;
        pointer-events: none;
    }
</style>
<script src="https://d3js.org/d3.v4.js"></script>

<body>
    <h1> QNL (History of Politics) and Class J (Politics) of UoS Library</h1>
    <h2 id="numbooks"></h2>
    <div id="svgcontent"></div>

    <script>

        d3.queue()

            .defer(d3.json, "File/CommonBooksJ-QNL.json")

            .await(function (error, books) {
                if (error) throw error;

                // set the dimensions and margins of the graph
                var margin = { top: 30, right: 30, bottom: 30, left: 130 },
                    width = 2000 - margin.left - margin.right,
                    height = 1000 - margin.top - margin.bottom;

                d3.select("#numbooks")
                    .text("Total number of Common Books: " + books.length);

                // append the svg object to the body of the page
                var svg = d3.select("#svgcontent")
                    .append("svg")
                    .attr("width", 3000)
                    .attr("height", 1500)
                    .append("g")
                    .attr("transform",
                        "translate(" + margin.left + "," + (margin.top + 100) + ")");

                //Read the data
                // console.log(books);

                var qnltitle = ["WORLD HISTORY AND HISTORY OF EUROPE, ASIA, AFRICA, AUSTRALIA, NEW ZEALAND, ETC.", "History of the Americas", "History of the Americas", "Political science (General)", "Political theory. The state. Theories of the state", "Political institutions and public administration", "Political institutions and public administration (United States)", "Political institutions and public administration(Canada, Latin America, etc.)", "Political institutions and public administration (Europe) ", "Political institutions and public administration (Asia,Africa, Australia, Pacific Area, etc.) ", "Local government. Municipal government", "Colonies and colonization. Emigration and immigration. International migration", "International law, see JZ and KZ", "International relations"];
                var uostitle = ["Political change and development", "International relations", "Political behaviour : participation in governmental process", "Government and public administration", "Political thought", "Generalities"];




                var qnlcols = [];
                var uosrows = [];
                var bookstruct = [];

                // Labels of row and columns
                for (var b = 0; b < books.length; b++) {


                    if (books[b].qnlcn.substr(1, 1).match(/[a-z]/i)) {

                        if (!qnlcols.includes(books[b].qnlcn.substr(0, 2))) {
                            qnlcols.push(books[b].qnlcn.substr(0, 2));
                        }
                    }

                    else {
                        if (!qnlcols.includes(books[b].qnlcn.substr(0, 1)))
                            qnlcols.push(books[b].qnlcn.substr(0, 1));

                    }



                    if (!uosrows.includes(books[b].uoscn.substr(0, 2)))
                        uosrows.push(books[b].uoscn.substr(0, 2));

                }

                qnlcols = qnlcols.sort(d3.ascending);
                uosrows = uosrows.sort(d3.descending);

                /*  for (var u = 0; u < uosrows.length; u++) {
                     uosrows[u] = uosrows[u] + uostitle[u];
                 } */


                for (var q = 0; q < qnlcols.length; q++) {
                    for (var u = 0; u < uosrows.length; u++) {

                        bookstruct.push({
                            "qnl": qnlcols[q],
                            "uos": uosrows[u],
                            "value": 0,
                            "title": [],
                            "cn": [],
                        });

                    }
                }

                /*  console.log(qnlcols);
                 console.log(uosrows);
                 console.log(bookstruct); */
                var qnln = "";
                var uosn = "";
                var maxValue = 0;

                for (var b = 0; b < books.length; b++) {


                    for (var bs = 0; bs < bookstruct.length; bs++) {

                        if (books[b].qnlcn.substr(1, 1).match(/[a-z]/i))
                            qnln = books[b].qnlcn.substr(0, 2);
                        else qnln = books[b].qnlcn.substr(0, 1);

                        uosn = books[b].uoscn.substr(0, 2);

                        // console.log();

                        if (bookstruct[bs].qnl == qnln && bookstruct[bs].uos == uosn) {
                            if (maxValue < bookstruct[bs].value + 1)
                                maxValue = bookstruct[bs].value + 1;
                            bookstruct[bs].value = bookstruct[bs].value + 1;
                            bookstruct[bs].title.push(books[b].title);
                            //console.log(books[b]);
                            if (books[b].uoscn != '')
                                bookstruct[bs].cn.push({
                                    "uoscn": books[b].uoscn,
                                    "qnlcn": books[b].qnlcn,
                                });
                        }

                    }



                }

                // console.log(maxValue);
                console.log(bookstruct);




                // Build X scales and axis:
                var x = d3.scaleBand()
                    .range([0, width])
                    .domain(qnlcols)
                    .padding(0.01);

                svg.append("g")
                    .style("font", "40px times")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));



                svg.append("text")
                    .attr("text-anchor", "end")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left + 70)
                    .attr("x", -margin.top - 300)
                    .style("font", "40px times")
                    .text("UoS Class J (Politics)");

                // Build X scales and axis:
                var y = d3.scaleBand()
                    .range([height, 0])
                    .domain(uosrows)
                    .padding(0.01);



                svg.append("g")
                    .style("font", "40px times")
                    .call(d3.axisLeft(y));

                svg.append("text")
                    .attr("text-anchor", "end")
                    .attr("x", width / 2)
                    .attr("y", height + margin.top + 100)
                    .style("font", "40px times")
                    .text("QNL (History of Politics)");

                // Build color scale
                /* var myColor = d3.scaleLinear()
                    .range(["white", "green"])
                    .domain([0, maxValue]); */


                var myColor = d3.scaleSqrt()
                    .range(["white", "green"])
                    .domain([0, maxValue]);

                /* var myColor = d3.scaleSequential()
                    .interpolator(d3.interpolateInferno)
                    .domain([0, maxValue]); */



                // create a tooltip
                var tooltip = d3.select("#svgcontent")
                    .append("div")
                    .style("opacity", 0)
                    .attr("class", "tooltip")
                    //.style("background-color", "white")
                    .style("border", "solid")
                    //.style("font", "40px times")
                    .style("border-width", "2px")
                    .style("border-radius", "5px")
                    .style("padding", "5px");




                // Three function that change the tooltip when user hover / move / leave a cell
                var mouseover = function (d) {
                    tooltip.style("opacity", 1)
                }
                var mousemove = function (d) {

                    tooltip
                        .html("<br>Number of common books: " + d.value + "<br><br> QNL Class: " + d.qnl + " (" + findQNLIndex(d.qnl) + ") <br><br> UoS Class: " + d.uos + " (" + findUOSIndex(d.uos) + ") ")
                        .style("left", (d3.mouse(this)[0] + 200) + "px")
                        .style("top", (d3.mouse(this)[1]) + "px")
                }
                var mouseleave = function (d) {
                    tooltip.style("opacity", 0)
                }


                var mouseclick = function (d) {
                    d3.select("body").select("table").remove();
                    var arrTable = [];

                    arrTable.push(["Title", "UoSCN", "QNLCN"]);

                    for (var i = 0; i < d.title.length; i++) {
                        d.cn;
                        arrTable.push([d.title[i], d.cn[i].uoscn, d.cn[i].qnlcn]);
                    }

                    tabulate(arrTable);
                    // console.log(d.title);
                    // console.log(d.cn);
                }



                // add the squares
                svg.selectAll()
                    .data(bookstruct, function (d) { return d.qnl + ':' + d.uos; })
                    .enter()
                    .append("rect")
                    .attr("x", function (d) { return x(d.qnl) })
                    .attr("y", function (d) { return y(d.uos) })
                    .attr("width", x.bandwidth())
                    .attr("height", y.bandwidth())
                    .style("border-width", "2px")
                    .style("border-color", "black")
                    .style("fill", function (d) { return myColor(d.value); })
                    .on("mouseover", mouseover)
                    .on("mousemove", mousemove)
                    .on("mouseleave", mouseleave)
                    .on("click", mouseclick);




                function tabulate(rows) {

                    console.log(rows);

                    var table = d3.select('body').append('table')
                        .style("border-collapse", "collapse")
                        .style("border", "2px black solid");

                    console.log(rows);
                    table.append("thead").append("tr")
                        .selectAll("th")
                        .data(rows[0])
                        .enter().append("th")
                        .text(function (d) { return d; })
                        .style("border", "1px black solid")
                        .style("padding", "5px")
                        .style("background-color", "#C1E1C1")
                        .style("font-weight", "bold")
                        .style("text-transform", "uppercase")
                        .style("font-size", "40px");

                    // data
                    table.append("tbody")
                        .selectAll("tr").data(rows.slice(1))
                        .enter().append("tr")
                        .selectAll("td")
                        .data(function (d) { return d; })
                        .enter().append("td")
                        .style("border", "1px black solid")
                        .style("padding", "5px")
                        .on("mouseover", function () {
                            d3.select(this).style("background-color", "powderblue");
                        })
                        .on("mouseout", function () {
                            d3.select(this).style("background-color", "white");
                        })
                        .text(function (d) { return d; })
                        .style("font-size", "30px");

                }


                function findQNLIndex(value) {

                    for (var q = 0; q < qnlcols.length; q++) {
                        if (qnlcols[q] == value)
                            return qnltitle[q];
                    }

                }

                function findUOSIndex(value) {
                    for (var u = 0; u < uosrows.length; u++) {
                        if (uosrows[u] == value)
                            return uostitle[u];
                    }

                }

            });
    </script>

</body>

</html>