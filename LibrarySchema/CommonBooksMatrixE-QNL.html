<html>

<head>
    <title>Matrix-: E & QNL</title>
</head>
<style>
    h1 {
        font: 60px sans-serif;
    }

    h2 {
        font: 50px times;
    }

    div.tooltip {
        position: absolute;
        text-align: center;
        width: 800px;
        height: 410px;
        padding: 2px;
        font: 40px sans-serif;
        background: rgb(149, 172, 240);
        border: 0px;
        margin-top: 40px;
        border-radius: 8px;
        pointer-events: none;
    }
</style>
<script src="https://d3js.org/d3.v4.js"></script>

<body>
    <h1>QNL (History of Politics) and Class E (History of America) of UoS Library</h1>
    <h2 id="numbooks"></h2>
    <div id="svgcontent"></div>

    <script>

        d3.queue()

            .defer(d3.json, "File/CommonBooksE-QNL.json")
            .defer(d3.json, "File/LCC-ClassE.json")
            .await(function (error, books, uosbooks) {
                if (error) throw error;



                // set the dimensions and margins of the graph
                var margin = { top: 30, right: 30, bottom: 30, left: 20 },
                    width = 4000 - margin.left - margin.right,
                    height = 1000 - margin.top - margin.bottom;

                d3.select("#numbooks")
                    .text("Total number of Common Books: " + books.length);

                // append the svg object to the body of the page
                var svg = d3.select("#svgcontent")
                    .append("svg")
                    .attr("width", 5000)
                    .attr("height", 1500)
                    .append("g")
                    .attr("transform",
                        "translate(" + (margin.left + 230) + "," + (margin.top + 100) + ")");

                //Read the data
                // console.log(books);

                var qnltitle = ["WORLD HISTORY AND HISTORY OF EUROPE, ASIA, AFRICA, AUSTRALIA, NEW ZEALAND, ETC.", "History of the Americas", "History of the Americas", "Political science (General)", "Political theory. The state. Theories of the state", "Political institutions and public administration", "Political institutions and public administration (United States)", "Political institutions and public administration(Canada, Latin America, etc.)", "Political institutions and public administration (Europe) ", "Political institutions and public administration (Asia,Africa, Australia, Pacific Area, etc.) ", "Local government. Municipal government", "Colonies and colonization. Emigration and immigration. International migration", "International law, see JZ and KZ", "International relations"];
                var uostitle = [];

                /*  for(var u=0;u<uosbooks.length;uos++)
                 {
                     uostitle
                 } */




                var qnlcols = [];
                var uosrows = [];
                var bookstruct = [];
                var uoscn = "";

                // Labels of row and columns
                for (var b = 0; b < books.length; b++) {

                    // console.log(books[b].uoscn);
                    if (books[b].qnlcn.substr(1, 1).match(/[a-z]/i)) {

                        if (!qnlcols.includes(books[b].qnlcn.substr(0, 2))) {
                            qnlcols.push(books[b].qnlcn.substr(0, 2));
                        }
                    }

                    else {
                        if (!qnlcols.includes(books[b].qnlcn.substr(0, 1)))
                            qnlcols.push(books[b].qnlcn.substr(0, 1));

                    }


                    /*  uoscn = books[b].uoscn.split(" ")[1];
                     if (!uosrows.includes(uoscn)) {
                         if (!uoscn.includes("."))
                             uosrows.push(uoscn);
                         else {
                             if (!uosrows.includes(uoscn.split(".")[0]))
                                 uosrows.push(uoscn.split(".")[0]);
                         }
 
                     } */
                }

                for (var u = 0; u < uosbooks.length; u++) {
                    if (uosbooks[u].name.charAt(0) == "E")
                        uosrows.push(uosbooks[u].name);
                }


                /* 
                console.log(books);
                */


                qnlcols = qnlcols.sort(d3.ascending);
                uosrows = uosrows.sort(d3.descending);

                /* console.log(uosrows);
                console.log(qnlcols); */


                for (var q = 0; q < qnlcols.length; q++) {
                    for (var u = 0; u < uosrows.length; u++) {

                        bookstruct.push({
                            "qnl": qnlcols[q],
                            "uos": uosrows[u],
                            "value": 0,
                            "title": [],
                            "cn": [],
                        });

                    }
                }

                /*  console.log(qnlcols);
                 console.log(uosrows);*/
                //console.log(bookstruct);
                var qnln = "";
                var uosn = "";
                var maxValue = 0;
                var limit1 = 0
                var limit2 = 0;
                var flag = 0;
                var usrow = "";
                var len = 0;
                var uosnfull = "";

                for (var b = 0; b < books.length; b++) {
                    //console.log(b);

                    for (var bs = 0; bs < bookstruct.length; bs++) {

                        flag = 0;

                        if (books[b].qnlcn.substr(1, 1).match(/[a-z]/i))
                            qnln = books[b].qnlcn.substr(0, 2);
                        else qnln = books[b].qnlcn.substr(0, 1);

                        uosnfull = books[b].uoscn;

                        uosn = books[b].uoscn.split(" ")[1];

                        if (uosn.includes("."))
                            uosn = uosn.split(".")[0];

                        //console.log(uosnfull);

                        for (var u = 0; u < uosrows.length; u++) {
                            len = uosrows[u].length - 1;
                            usrow = uosrows[u].substr(1, len);
                            //    console.log(usrow);
                            if (uosrows[u].includes("-")) {

                                //  console.log(uosrows[u]);
                                limit1 = usrow.split("-")[0];
                                limit2 = usrow.split("-")[1];
                                //console.log(limit1);
                                //console.log(limit2);
                                if (uosn >= limit1 && uosn <= limit2) {
                                    //console.log(limit1 + " " + uosn + " " + limit2);
                                    // console.log("match " + "-");
                                    // console.log("matchflag " + uosn + " " + limit1 + "-" + limit2);
                                    //console.log("flag");
                                    flag = 1;
                                    break;
                                }
                            }
                            else {
                                if (uosn == usrow || uosn == Math.round(usrow)) {
                                    //console.log("matchflag ==" + usrow);
                                    // console.log("flag");
                                    flag = 1;
                                    break;
                                }

                            }

                            // console.log("fl");

                        }

                        //  console.log("out brk");
                        len = bookstruct[bs].uos;
                        //console.log(bookstruct[bs].uos);
                        usrow = "E" + usrow;
                        if (bookstruct[bs].qnl == qnln && flag == 1 && bookstruct[bs].uos == usrow) {
                            // console.log(bookstruct[bs].qnl);
                            //console.log("match");


                            if (maxValue < bookstruct[bs].value + 1)
                                maxValue = bookstruct[bs].value + 1;
                            bookstruct[bs].value = bookstruct[bs].value + 1;
                            bookstruct[bs].title.push(books[b].title);
                            //console.log(books[b]);
                            if (books[b].uoscn != '')
                                bookstruct[bs].cn.push({
                                    "uoscn": books[b].uoscn,
                                    "qnlcn": books[b].qnlcn,
                                });
                        }

                        //end up

                    }



                }

                console.log(maxValue);
                console.log(bookstruct);




                // Build X scales and axis:
                var x = d3.scaleBand()
                    .range([0, width])
                    .domain(uosrows)
                    .padding(0.01);

                svg.append("g")
                    .attr("transform", "rotate(90)")
                    .style("font", "25px times")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

                svg.selectAll("text")
                    .attr("y", 0)
                    .attr("x", 29)
                    .attr("dy", ".35em")
                    .style("font", "25px times")
                    .attr("transform", "rotate(90)")
                    .style("text-anchor", "start");

                svg.append("text")
                    .attr("text-anchor", "end")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -200)
                    .attr("x", -350)
                    /*  .attr("y", -margin.left + 30)
                     .attr("x", -margin.top - 300) */

                    .style("font", "40px times")
                    .text("QNL (History of Politics)");


                // Build X scales and axis:
                var y = d3.scaleBand()
                    .range([height, 0])
                    .domain(qnlcols)
                    .padding(0.01);

                svg.append("g")
                    .style("font", "25px times")
                    .call(d3.axisLeft(y));

                svg.append("text")
                    .attr("text-anchor", "end")
                    /* .attr("x", width / 2)
                    .attr("y", height + margin.top + 100) */
                    .attr("x", 2000)
                    .attr("y", 1300)
                    .style("font", "40px times")
                    .text("UoS Class E (History of America)");


                // Build color scale
                /* var myColor = d3.scaleLinear()
                    .range(["white", "green"])
                    .domain([0, maxValue]); */


                var myColor = d3.scaleSqrt()
                    .range(["white", "blue"])
                    .domain([0, maxValue]);

                /* var myColor = d3.scaleSequential()
                    .interpolator(d3.interpolateInferno)
                    .domain([0, maxValue]); */



                // create a tooltip
                var tooltip = d3.select("#svgcontent")
                    .append("div")
                    .style("opacity", 0)
                    .attr("class", "tooltip")
                    //.style("background-color", "white")
                    .style("border", "solid")
                    //.style("font", "40px times")
                    .style("border-width", "2px")
                    .style("border-radius", "5px")
                    .style("padding", "5px");




                // Three function that change the tooltip when user hover / move / leave a cell
                var mouseover = function (d) {
                    tooltip.style("opacity", 1)
                }
                var mousemove = function (d) {

                    tooltip
                        .html("<br>Number of common books: " + d.value + "<br><br> QNL Class: " + d.qnl + " (" + findQNLIndex(d.qnl) + ") <br><br> UoS Class: " + d.uos + " (" + findUOSIndex(d.uos) + ") ")
                        .style("left", (d3.mouse(this)[0] + 400) + "px")
                        .style("top", (d3.mouse(this)[1]) + "px")
                }
                var mouseleave = function (d) {
                    tooltip.style("opacity", 0)
                }


                var mouseclick = function (d) {
                    d3.select("body").select("table").remove();
                    var arrTable = [];

                    arrTable.push(["Title", "QNLCN", "UoSCN"]);

                    for (var i = 0; i < d.title.length; i++) {
                        d.cn;
                        arrTable.push([d.title[i], d.cn[i].qnlcn, d.cn[i].uoscn]);
                    }

                    tabulate(arrTable);
                    // console.log(d.title);
                    // console.log(d.cn);
                }

                console.log(bookstruct);

                // add the squares
                svg.selectAll()
                    .data(bookstruct, function (d) { return d.qnl + ':' + d.uos; })
                    .enter()
                    .append("rect")
                    .attr("x", function (d) { return x(d.uos) })
                    .attr("y", function (d) { return y(d.qnl) })
                    .attr("width", x.bandwidth())
                    .attr("height", y.bandwidth())
                    .style("border-width", "2px")
                    .style("border-color", "black")
                    .style("fill", function (d) { return myColor(d.value); })
                    .on("mouseover", mouseover)
                    .on("mousemove", mousemove)
                    .on("mouseleave", mouseleave)
                    .on("click", mouseclick);




                function tabulate(rows) {

                    console.log(rows);

                    var table = d3.select('body').append('table')
                        .style("border-collapse", "collapse")
                        .style("border", "2px black solid");

                    console.log(rows);
                    table.append("thead").append("tr")
                        .selectAll("th")
                        .data(rows[0])
                        .enter().append("th")
                        .text(function (d) { return d; })
                        .style("border", "1px black solid")
                        .style("padding", "5px")
                        .style("background-color", "#B6DDF6")
                        .style("font-weight", "bold")
                        .style("text-transform", "uppercase")
                        .style("font-size", "40px");

                    // data
                    table.append("tbody")
                        .selectAll("tr").data(rows.slice(1))
                        .enter().append("tr")
                        .selectAll("td")
                        .data(function (d) { return d; })
                        .enter().append("td")
                        .style("border", "1px black solid")
                        .style("padding", "5px")
                        .on("mouseover", function () {
                            d3.select(this).style("background-color", "powderblue");
                        })
                        .on("mouseout", function () {
                            d3.select(this).style("background-color", "white");
                        })
                        .text(function (d) { return d; })
                        .style("font-size", "30px");

                }


                function findQNLIndex(value) {

                    for (var q = 0; q < qnlcols.length; q++) {
                        if (qnlcols[q] == value)
                            return qnltitle[q];
                    }

                }

                function findUOSIndex(value) {
                    for (var u = 0; u < uosbooks.length; u++) {
                        if (uosbooks[u].name == value)
                            return uosbooks[u].title;
                    }

                }

            });
    </script>

</body>

</html>