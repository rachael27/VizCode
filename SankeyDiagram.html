<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/d3-array@1"></script>
<script src="https://unpkg.com/d3-collection@1"></script>
<script src="https://unpkg.com/d3-path@1"></script>
<script src="https://unpkg.com/d3-shape@1"></script>
<script src="https://unpkg.com/d3-sankey@0"></script>


<body>
    <div id="my_dataviz"></div>
    <script type="text/javascript">


        var svg = d3.select("#my_dataviz")
            .append("svg")
            .attr("width", 2400)
            .attr("height", 2000);




        //DATASET 1
        // create input data: a square matrix that provides the flow between items
        /*  var items = ["Adidas", "Converse", "Nike", "Puma", "Under Armor"];
         var matrix = [
             [0, 2, 1, 1, 0],
             [2, 0, 2, 1, 0],
             [2, 1, 0, 0, 0],
             [1, 0, 2, 0, 2],
             [1, 2, 2, 2, 0]
         ]; */


        /* //DATASET 2
        var items = ["Apple", "Nokia", "Samsung", "Sony"];
        var matrix = [
            [0, 1, 1, 0],
            [2, 0, 2, 1],
            [2, 1, 0, 1],
            [2, 1, 2, 0]
        ]; */


        //DATASET 3
        var items = ["Britain", "France", "Germany", "Greece", "Italy", "Spain", "United States"];
        var matrix = [
            [0, 0, 1, 0, 0, 1, 0],
            [0, 0, 0, 0, 0, 2, 2],
            [0, 0, 0, 2, 3, 3, 1],
            [2, 0, 0, 0, 2, 0, 0],
            [3, 1, 2, 0, 0, 0, 1],
            [2, 3, 1, 0, 2, 1, 0],
            [0, 0, 0, 1, 2, 3, 1]
        ];



        var colorScale = d3.scaleOrdinal().domain(items)
            .range(["#0087DC", "#DC241f", "#6AB023", "#70147A", "#FDBB30", "#614126", "#4e79a7"]);



        var svg = d3.select("svg"),
            margin = { top: 300, right: 160, bottom: 50, left: 250 },
            width = +svg.attr("width") - margin.left - margin.right,
            height = +svg.attr("height") - margin.top - margin.bottom;

        var g = svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + 300 + ")");

        var
            color = d3.scaleOrdinal(d3.schemeCategory10);

        //console.log(height);

        var sankey = d3.sankey()
            //.nodeWidth(15)
            .nodePadding(10)
            //.nodeSort(a, b)
            //.iterations(1)
            .extent([[1, 1], [width - 200, height - 200]])
            .iterations(0);

        var link = g.append("g")
            .attr("class", "links")
            .attr("fill", "none")
            .attr("stroke", "#000")
            .attr("stroke-opacity", 0.2)
            .selectAll("path");

        var node = g.append("g")
            .attr("class", "nodes")
            .attr("font-family", "sans-serif")
            .attr("font-size", 10)
            .selectAll("g");

        var indexLookup = {};

        var pollNodes = {
            "nodes": [],
            "links": []
        };

        for (var i = 0; i < items.length; i++) {
            pollNodes.nodes.push({ "name": items[i] + "_left" });
            //pollNodes.nodes.push({ "name": items[i] + "_right" });
        }
        for (var i = 0; i < items.length; i++) {
            //pollNodes.nodes.push({ "name": items[i] + "_left" });
            pollNodes.nodes.push({ "name": items[i] + "_right" });
        }


        for (var r = 0; r < items.length; r++) {
            for (var c = 0; c < items.length; c++) {
                //console.log(r + " " + c);
                if (matrix[r][c] != 0)
                    pollNodes.links.push({
                        /* "source": items[r],
                        "target": items[c], */

                        "source": r,
                        "target": items.length + c,
                        "value": matrix[r][c]


                    });
            }
        }

        //console.log(pollNodes);


        // generate sankey layout
        sankey(pollNodes);

        //console.log(pollNodes);

        //console.log("hi");

        console.log(pollNodes);
        //console.log(d3.sankeyLinkHorizontal());

        link = link
            .data(pollNodes.links)
            .enter()
            .append("path")
            .attr("d", d3.sankeyLinkHorizontal())
            .attr("class", function (d) {
                //console.log(d);
                var name = d.source.name.substring(0, d.source.name.indexOf("_"));
                return name.replace(" ", "");

            })
            .attr("stroke-width", function (d) {
                return Math.max(1, d.width);
            })
            .attr("stroke", function (d, i) {
                //console.log(i);
                return colorScale(d.source.index);
            })
            .on("mouseover", function () {
                d3.select(this)
                    .attr("stroke-opacity", 0.6);
            })
            .on("mouseout", function () {
                d3.select(this)
                    .attr("stroke-opacity", 0.2);
            })

        link.append("title")
            .text(function (d) {
                //console.log(d.source.name + " " + d.target.name + " " + d.value);
                return "Flow from " + d.source.name.substring(0, d.source.name.indexOf("_")) + " to " + d.target.name.substring(0, d.target.name.indexOf("_")) + " " + d.value;
                //return d.value;
            });

        node = node
            .data(pollNodes.nodes)
            .enter()
            .append("g")
            .attr("transform", function (d) {

                return "translate(" + d.x0 + "," + d.y0 + ")";
            });

        node.append("rect")
            .attr("height", function (d) {

                return d.y1 - d.y0;
            })
            .attr("width", sankey.nodeWidth() + 10)
            .attr("fill", function (d, i) {

                if (i < items.length)
                    return colorScale(i) || "#D3D3D3";
                else
                    return colorScale(i - items.length) || "#D3D3D3";
            })
            .on("click", function (e, d, i) {

                var name = d.name.substring(0, d.name.indexOf("_"));

                d3.selectAll("." + name.replace(" ", "")).style("stroke-opacity", 0.8);
            })
            .append("title")
            .text(function (d) { return d.name.substring(0, d.name.indexOf("_")) + "\n" + d.value; });

        node.append("text")
            .attr("x", sankey.nodeWidth() + 20)
            .attr("y", function (d) { return (d.y1 - d.y0) / 2; })
            .attr("dy", "0.35em")
            .attr("text-anchor", "start")
            .attr("transform", null)
            .text(function (d) { return d.name.substring(0, d.name.indexOf("_")); })
            .style("font-size", "40px")
            .filter(function (d) {
                //console.log(d.x0);
                return (d.x0) <= 1;
            })
            .attr("x", sankey.nodeWidth() - 35)
            .attr("text-anchor", "end");


    </script>

</body>

</html>