<!DOCTYPE html>
<meta charset="utf-8">

<head>

    <style>
        .node {
            cursor: pointer;
        }

        .node circle {
            fill: #9b8f8f;
            stroke: steelblue;
            stroke-width: 3px;
        }

        .node text {
            font: 12px sans-serif;
        }

        .link {
            fill: none;
            stroke: hsl(216, 54%, 36%);
            stroke-width: 0.5px;
        }

        div.tooltip {
            position: absolute;
            text-align: center;
            width: 200px;
            height: 50px;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }


        /*
        #lccontent, #dccontent, #space {
           
  display: inline-block;
}
*/
    </style>



</head>
<!-- Load d3.js -->

<body>
    <button id="zoom_in" onclick="zoomin()">+</button>
<button id="zoom_out" onclick="zoomout()">-</button>
<br>
<br>
<button id="rotate" onclick="rotateviz()">Rotate Viz</button> <button id="sort" onclick="rotateviz()">Sort A-Z Viz</button>
<br>
<br>
<input type="text" id="searchtext" value="England"></input>
<button id="search" onclick="searchnode()">Search</button>

<br>
<br>

    <button onclick="clearColor()">Clear Color</button>
    <button onclick="clearCaptions()">Clear Captions</button>
    <button onclick="addCaptions()">Add Captions</button>


    <div id="lccontent">
        <h1>Library of Congress</h1>

    </div>
    <div id="space"></div>
   

    </div>


    <script src="https://code.jquery.com/jquery-1.7.2.js"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script type="text/javascript">

        var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);



        var data = []; var lccdata = []; var dcdata = []; var lcset = new Set();
        var dcset = new Set();

       


        d3.csv("LC-DC.csv", function (data) {

            //console.log(data.length);
            for (i = 0; i < 1200; i++) {
            //start reading lcc file
                if (!lcset.has(data[i].lccchild)) {

                   
                    if(data[i].lccchild=="LCC"){
                    lccdata.push({ "lccchild": data[i].lccchild, "lccparent": data[i].lccparent, "lcccaption": data[i].lcccaption, "lccclass": data[i].lccchild });
                    lcset.add(data[i].lccchild);
                }

                else { //for every other node that isnt the root

var lccode=data[i].lccchild.split(" ");
//console.log(data[i].lccchild+" "+lccode.length);
if(lccode.length==1) //if there is a space in the lcchild
{
    if(lccode[0].length==1){ //if it is a single letter eg. A
 //   console.log(data[i].lccchild);
    lccdata.push({ "lccchild": data[i].lccchild, "lccparent": data[i].lccparent, "lcccaption": data[i].lcccaption, "lccclass": data[i].lccchild });
    lcset.add(data[i].lccchild);
    }

    else if(lccode[0].length==2){ //if it is a DOUBLE letter eg. AC add A,AC
 //   console.log(data[i].lccchild.charAt(0)+" "+data[i].lccchild.charAt(0)+data[i].lccchild.charAt(1));
    lccdata.push({ "lccchild": data[i].lccchild, "lccparent": data[i].lccparent, "lcccaption": data[i].lcccaption, "lccclass": data[i].lccchild.charAt(0)+" "+data[i].lccchild.charAt(0)+data[i].lccchild.charAt(1) });
    lcset.add(data[i].lccchild);
    }
}

else{  //size of array is more than 1
//console.log("lccode "+lccode[0]+lccode[0].length);
if(lccode[0].length==1){ //if it is a single letter on 1 side of the array eg. A 100
//    console.log("l1 "+data[i].lccchild);
lccdata.push({ "lccchild": data[i].lccchild, "lccparent": data[i].lccparent, "lcccaption": data[i].lcccaption, "lccclass": data[i].lccchild });
lcset.add(data[i].lccchild);
}

else if(lccode[0].length==2){ //if it is a double letter on 1 side of the array eg. AC 100
//    console.log("l2 "+data[i].lccchild.charAt(0)+" "+data[i].lccchild.charAt(0)+data[i].lccchild.charAt(1));
lccdata.push({ "lccchild": data[i].lccchild, "lccparent": data[i].lccparent, "lcccaption": data[i].lcccaption, "lccclass": data[i].lccchild.charAt(0)+" "+data[i].lccchild.charAt(0)+data[i].lccchild.charAt(1) });
lcset.add(data[i].lccchild);
}

}

                   
                }



                  
                }
                //finish reading lcc file
                




              
            } //finish reading csv file


            console.log(lccdata);
         
            sortedlccdata = lccdata.slice().sort((a, b) => d3.ascending(a.lcccaption, b.lcccaption));
            console.log(sortedlccdata);

            // STRATIFY PARAMS
            //setting stratify params for LCC
            //  console.log(data.columns);
            var lccchild = "lccchild";
            //console.log(child);
            var lccparent = "lccparent";
            stratify = d3.stratify()
                .id(function (d) {
                    return d[lccchild];
                })
                .parentId(function (d) {
                    return d[lccparent];
                });
            var lccstratify = stratify(sortedlccdata);
           // var lccstratify = stratify(lccdata);
            //   console.log(lccstratify);


          



            // SETTING MARGINS 
            
           var lccmargin = { top: 100, right: 110, bottom: -100, left: 120 },
                height = 1000 - lccmargin.right - lccmargin.left,
                width = 1000 - lccmargin.top - lccmargin.bottom,
                rectW = 70,
            rectH = 30,
            //bbox = NaN,
            maxTextLength = 0;
            

           
            // MARGINS CLOSE


            //COMPUTE LAYOUT FOR LCC + DC

            var lccroot = d3.hierarchy(lccstratify);
            //  console.log(lccroot.descendants());
            //  console.log(lccroot.links());


           
            //LAYOUT OVER 


            //SETTING UP LCC PROPERTIES FOR SVG, TREE, NODES AND LINKS

            d3.select("#lccontent").append("h4")
            .text("Total no. of nodes "+lccdata.length);
                //.style("font-size", "8px");

                


            var lccsvg = d3.select("#lccontent")
                .append("svg")
                .attr("width", 2000)
                .attr("height", 2000);

            var g = lccsvg
                .append("g")
                .attr("transform", "translate(" + (width + 100) + "," + (height  + 90) + ")");
            var radius = 700;


            var lcctree = d3.tree()
                .size([2 * Math.PI, radius])
                .separation(function (a, b) { return (a.parent == b.parent ? 1 : 2) / a.depth; });

            var lccroot = lcctree(d3.hierarchy(lccstratify));
                console.log(lccroot.links());
                console.log(lccroot.descendants());

            var lcclink = g.selectAll(".link")
                .data(lccroot.links())
                /*
                 .data(lccroot.links().filter(function(d) { 
                    // console.log(lccroot.links());
                    return d.source.height <=1; }))
                    */
                .enter()
                .append("path")
                .attr("class", "link")
                .attr("d", d3.linkRadial()
                    .angle(function (d) { return d.x; })
                    .radius(function (d) { return d.y; }));


            var lccnode = g.selectAll(".node")
                .data(lccroot.descendants())
                /*
                  .data(lccroot.descendants().filter(function(d) { return d.height ==1 ; }))
                  */
                .enter()
                .append("g")
                .attr("class", function (d) {
                    return d.data.data.lccclass;
                })
                .attr("class", function (d) { return "node" + (d.children ? " node--internal" : " node--leaf")+" "+d.data.data.lccclass; })
                .attr("transform", function (d) { return "translate(" + radialPoint(d.x, d.y) + ")"; })


                .on("dblclick", function (d) {
                    console.log("double clicked");
                    
                    updatedlccnodes = d.descendants();
                    updatedlcclinks = d.links();
                    updatelcc(updatedlccnodes, updatedlcclinks);
                 
                    
                })

                .on("click", function (d) {
                    console.log("clicked");
                    var htmlclass = d.data.data.lccclass;
                    lccsvg.selectAll("."+htmlclass).selectAll("text").style("fill", "blue");

                   // lccsvg.selectAll("."+htmlclass).attr("transform", function (d) { return "translate(" + radialPoint(d.x, d.y) + ")"; })
                  
                 
                })
                .on("mouseover", function (d) {



                    var filtered = lccnode.filter(function (e) {
                        return d.ancestors().indexOf(e) > -1
                    });
                    //  console.log(filtered);
                    filtered.selectAll("circle").style("fill", "red");
                    filtered.selectAll("text").style("fill", "red");

                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html(d.data.data.lcccaption + "<br/>" + d.data.data.lccchild)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");



                })
                .on("mouseout", function (d) {
                    var filtered = lccnode.filter(function (e) {
                        return d.ancestors().indexOf(e) > -1
                    });
                    filtered.selectAll("circle").style("fill", "#555");
                    filtered.selectAll("text").style("fill", "#555");

                    div.transition()
                        .duration(500)
                        .style("opacity", 0);


                });

            lccnode.append("text")
                .style("font-size", "12px")
                .attr("dy", "0.31em")
                .attr("x", function (d) { return d.x < Math.PI === !d.children ? 6 : -6; })
                .attr("text-anchor", function (d) { return d.x < Math.PI === !d.children ? "start" : "end"; })
                .attr("transform", function (d) { return "rotate(" + (d.x < Math.PI ? d.x - Math.PI / 2 : d.x + Math.PI / 2) * 180 / Math.PI + ")"; })
                .text(function (d) {
                    // console.log(d); 
                    // return "hi"; });
                    return d.data.data.lcccaption;
                });

            // SETTING UP OVER FOR LCC



            var spacesvg = d3.select("#space")
                .append("svg")
                .attr("width", 100)
                .attr("height", 100);



                //var htmlclass = d.data.data.lccclass;
                  //  lccsvg.selectAll("."+htmlclass).selectAll("text").style("fill", "purple");

              







            //UPDATE FOR LCC
            function updatelcc(updatedlccnodes, updatedlcclinks) {

                lccsvg.selectAll('.node').remove();
                lccsvg.selectAll('.link').remove();
                console.log("Reached");
                console.log(updatedlccnodes);
                console.log(updatedlcclinks);


                //updatednodes=root(updatednodes);
                //updatedlinks=root(updatedlinks);


                var lcclink = lccsvg.selectAll("g").selectAll(".link")
                    .data(updatedlcclinks)
                    // .data(root.links().filter(function(d) { return d.source.depth <=1 }))
                    .enter()
                    .append("path")
                    .attr("class", "link")
                    .attr("d", d3.linkRadial()
                        .angle(function (d) { return d.x; })
                        .radius(function (d) { return d.y; }));


                var lccnode = lccsvg.selectAll("g").selectAll(".node")
                    .data(updatedlccnodes)
                    //  .data(root.descendants().filter(function(d) { return d.depth <= 2 }))
                    .enter()
                    .append("g")
                    .attr("class", function (d) { return "node" + (d.children ? " node--internal" : " node--leaf"); })
                    .attr("transform", function (d) { return "translate(" + radialPoint(d.x, d.y) + ")"; })
                    .on("dblclick", function (d) {
                        
                    })
                    .on("click", function (d) {

                        var filtered = lccnode.filter(function (e) {
                            return d.descendants().indexOf(e) >= 1
                        });

                        filtered.selectAll("text").style("fill", "yellow");

                    })
                    .on("mouseover", function (d) {
                        var filtered = lccnode.filter(function (e) {
                            return d.ancestors().indexOf(e) > -1
                        });
                        console.log(filtered);
                        filtered.selectAll("circle").style("fill", "red");
                        filtered.selectAll("text").style("fill", "red");

                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html(d.data.data.lcccaption + "<br/>" + d.data.data.lccchild)
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");

                    })
                    .on("mouseout", function (d) {
                        var filtered = lccnode.filter(function (e) {
                            return d.ancestors().indexOf(e) > -1;
                        });
                        filtered.selectAll("circle").style("fill", "#555");
                        filtered.selectAll("text").style("fill", "#555");

                        div.transition()
                            .duration(500)
                            .style("opacity", 0);



                    });



                lccnode.append("text")
                    .style("font-size", "10px")
                    .attr("dy", "0.9em")
                    .attr("x", function (d) { return d.x < Math.PI === !d.children ? -20 : 15; })
                    .attr("text-anchor", function (d) { return d.x < Math.PI === !d.children ? "start" : "end"; })
                    .attr("transform", function (d) { return "rotate(" + (d.x < Math.PI ? d.x - Math.PI / 2 : d.x + Math.PI / 2) * 180 / Math.PI + ")"; })
                    .text(function (d) {
                        // console.log(d); 
                        return d.data.data.lcccaption;
                        //    return d.data.data.caption; 
                    });

            }
            //UPDATE OVER FOR LCC






           

        });



        function radialPoint(x, y) {
            return [(y = +y) * Math.cos(x -= Math.PI / 2), y * Math.sin(x)];
        }

        function clearColor() {
            d3.select("#lccontent")
                .select("svg")
                .select("g")
                .selectAll("g")
                //.selectAll("circle").style("fill", "black")
                .selectAll("text").style("fill", "black");



        }


        function clearCaptions() {
            d3.select("#lccontent")
                .select("svg")
                .select("g")
                .selectAll("g")
                //.selectAll("circle").style("fill", "black")
                .selectAll("text").style("opacity", 0);


           
        }


        function addCaptions() {
            d3.select("#lccontent")
                .select("svg")
                .select("g")
                .selectAll("g")
                //.selectAll("circle").style("fill", "black")
                .selectAll("text").style("opacity", 1);


           
        }

        function zoomin(){
            var lccmargin = { top: 100, right: 110, bottom: -100, left: 120 },
                height = 1000 - lccmargin.right - lccmargin.left,
                width = 1000 - lccmargin.top - lccmargin.bottom,
                rectW = 70;
            rectH = 30;
            var x=width/4,
            y=height/4, 
            k=2;

            d3.select("#lccontent")
                .select("svg")
                .select("g")
           // .duration(750)
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");

        }

        function zoomout(){
            var lccmargin = { top: 100, right: 110, bottom: -100, left: 120 },
                height = 1000 - lccmargin.right - lccmargin.left,
                width = 1000 - lccmargin.top - lccmargin.bottom,
                rectW = 70;
            rectH = 30;
            var x=width/2,
            y=height/2, 
            k=1;

            d3.select("#lccontent")
                .select("svg")
                .select("g")
           // .duration(750)
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");

        }




function rotateviz(){
    var lccmargin = { top: 100, right: 110, bottom: -100, left: 120 },
                height = 1000 - lccmargin.right - lccmargin.left,
                width = 1000 - lccmargin.top - lccmargin.bottom;

                var rotatevalue=15;

    d3.select("#lccontent")
                .select("svg")
                .select("g")
           // .duration(750)
      .attr("transform", "translate(" + (width + 100) + "," + (height  + 90) + ")"+ "rotate("+(15+rotatevalue)+")");

}

function rotateviz(){
    people.slice().sort((a, b) => d3.ascending(a.last, b.last) || d3.ascending(a.first, b.first))
}

function searchnode(){
    console.log(lccdata);

    /*
    var filtered = lccdata.filter(function (e) {
        console.log(document.getElementById("searchtext").value+" "+e.lcccaption);
                            if(e.lcccaption.includes(document.getElementById("searchtext").value)){
                                console.log("search"+e.lcccaption);
                            return e.lccchild;
       
       return (e.lcccaption).includes(document.getElementById("searchtext").value);
    }
                        });
                        console.log(filtered);
*/
         d3.select("#lccontent")
                .select("svg")
                .selectAll("g")
                .select("text")
                .style("fill", function(d) {
                    console.log(d.data.data.lcccaption);
               return  (d.data.data.lcccaption).includes(document.getElementById("searchtext").value)? "green" : "black"})  
               .style("font-size", function(d) {
                    console.log(d.data.data.lcccaption);
               return  (d.data.data.lcccaption).includes(document.getElementById("searchtext").value)? "20px" : "12px"});  

}








    </script>
</body>

</html>